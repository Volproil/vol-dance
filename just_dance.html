<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Just Dance Mobile - 5 –ò–≥—Ä–æ–∫–æ–≤</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Montserrat', sans-serif;
      height: 100vh;
      width: 100vw;
      /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–∫—Ä—É—Ç–∫—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
      touch-action: manipulation;
      color: #fff;
    }

    /* –í–∏–¥–µ–æ –∏ –∫–∞–Ω–≤–∞—Å */
    #videoElement, #canvasOutput {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      transform: scaleX(-1); /* –ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ */
    }

    /* –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
    .multi-score-bar {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      z-index: 10;
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 0 10px;
      flex-wrap: wrap;
    }

    .player-score {
      padding: 10px 18px;
      color: white;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      background: rgba(0,0,0,0.7);
      border: 2px solid rgba(255,255,255,0.3);
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      min-width: 130px;
      text-align: center;
    }

    .timer {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,69,0,0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      font-size: 24px;
      font-weight: bold;
      z-index: 10;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.8);
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      animation: timerGrow 0.3s ease-out;
    }

    /* –ù–∏–∂–Ω—è—è –ø–æ–ª–æ—Å–∞ –∫–æ–º–∞–Ω–¥ */
    .bottom-commands-area {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 120px;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.5) 70%, rgba(0,0,0,0) 100%);
      backdrop-filter: blur(8px);
      z-index: 10;
      overflow: hidden;
      display: flex;
      align-items: center;
      padding: 0 20px;
    }

    .current-move-visual {
        position: absolute;
        right: -300px;
        width: 250px;
        height: 100px;
        background: rgba(255,255,255,0.15);
        border-radius: 15px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        color: white;
        font-weight: bold;
        text-shadow: 1px 1px 4px rgba(0,0,0,0.6);
        border: 2px solid rgba(255,255,255,0.3);
        box-shadow: 0 0 15px rgba(0,0,0,0.5);
        opacity: 0;
        animation: none;
        flex-direction: column; /* –î–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ç–µ–∫—Å—Ç–∞ */
    }

    .current-move-visual img {
        max-width: 90%;
        max-height: 80%;
        object-fit: contain;
        margin-bottom: 5px; /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏ —Ç–µ–∫—Å—Ç–æ–º */
    }

    .current-move-visual span {
        font-size: 18px;
        color: rgba(255,255,255,0.8);
        text-align: center;
    }

    .controls {
      position: absolute;
      bottom: 130px;
      left: 10px;
      right: 10px;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 10;
    }

    .btn {
      background: linear-gradient(45deg, #ff0099, #493240);
      color: white;
      font-size: 18px;
      font-weight: bold;
      padding: 15px 25px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      transition: all 0.3s ease;
      min-width: 150px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn:hover {
      background: linear-gradient(45deg, #ff1493, #6a0572);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: scale(0.95) translateY(0);
      box-shadow: 0 3px 12px rgba(0,0,0,0.3);
    }

    .final-screen {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 22px;
      z-index: 20;
      text-align: center;
      padding: 20px;
      animation: fadeIn 0.5s ease-out;
    }

    .final-screen .btn {
        margin-top: 30px;
        background: linear-gradient(45deg, #00c6ff, #0072ff);
    }

    .final-screen .btn:hover {
        background: linear-gradient(45deg, #00b0ff, #0056ff);
    }

    .loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 20px;
      z-index: 30;
      background: rgba(0,0,0,0.95);
      backdrop-filter: blur(15px);
      animation: fadeIn 0.5s ease-in;
    }
    .loading div:first-child {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 15px;
        animation: pulseText 1.5s infinite;
    }
    .loading div:last-child {
        font-size: 14px;
        color: rgba(255,255,255,0.7);
    }

    .performance-info {
      position: absolute;
      bottom: 10px;
      left: 20px;
      color: rgba(255,255,255,0.8);
      font-size: 13px;
      background: rgba(0,0,0,0.6);
      padding: 8px 15px;
      border-radius: 15px;
      z-index: 10;
      backdrop-filter: blur(5px);
      display: flex;
      gap: 15px;
      align-items: center;
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç "Perfect" */
    #perfectEffect {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        font-size: 80px;
        font-weight: bold;
        color: #ffeb3b;
        text-shadow: 0 0 20px rgba(255,235,59,0.8), 0 0 40px rgba(255,235,59,0.6);
        z-index: 15;
        opacity: 0;
        pointer-events: none;
        animation: none;
        font-family: 'Bungee Outline', cursive;
        -webkit-text-stroke: 3px #ff1493;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
      .multi-score-bar {
        gap: 10px;
        top: 15px;
      }
      .player-score {
        font-size: 14px;
        padding: 8px 15px;
        min-width: 110px;
      }
      .timer {
        font-size: 20px;
        padding: 10px 18px;
        top: 15px;
        right: 15px;
      }
      .bottom-commands-area {
        height: 100px;
        padding: 0 10px;
      }
      .current-move-visual {
        width: 200px;
        height: 80px;
        font-size: 20px;
      }
      .controls {
        bottom: 110px;
        gap: 10px;
      }
      .btn {
        font-size: 16px;
        padding: 12px 20px;
        min-width: 110px;
      }
      .final-screen {
        font-size: 18px;
      }
      #perfectEffect {
          font-size: 60px;
      }
      .loading div:first-child {
          font-size: 20px;
      }
      .performance-info {
        bottom: 5px;
        left: 10px;
        font-size: 12px;
      }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes perfectPulse {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
        30% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
    }

    @keyframes pulseText {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes timerGrow {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    @keyframes slideInMove {
        from { right: -300px; opacity: 0; }
        20% { opacity: 1; }
        to { right: 50%; transform: translateX(50%); opacity: 1; }
    }

    @keyframes fadeOutMove {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(-100px); }
    }

  </style>
  <link href="https://fonts.googleapis.com/css2?family=Bungee+Outline&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <video id="videoElement" autoplay muted playsinline></video>
  <canvas id="canvasOutput"></canvas>

  <div class="loading" id="loadingText">
    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...</div>
    <div style="font-size: 12px; margin-top: 10px;">–î–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ö–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ</div>
  </div>

  <div class="multi-score-bar" id="multiScoreBar"></div>
  <div class="timer" id="timer">60</div>

  <div class="bottom-commands-area">
      <div class="current-move-visual" id="currentMoveVisual">
          –ì–æ—Ç–æ–≤—å—Å—è!
      </div>
  </div>

  <div class="controls">
    <button class="btn" onclick="togglePause()">‚èØ –ü–∞—É–∑–∞</button>
    <button class="btn" onclick="restartGame()">üîÑ –ó–∞–Ω–æ–≤–æ</button>
  </div>

  <div class="performance-info" id="performanceInfo">FPS: -- | –ò–≥—Ä–æ–∫–æ–≤: --</div>

  <div class="final-screen" id="finalScreen">
    <div style="font-size: 28px; margin-bottom: 25px; font-weight: bold; text-shadow: 2px 2px 8px rgba(0,0,0,0.7);">üéâ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ</div>
    <div id="finalScores" style="font-size: 20px;"></div>
    <button class="btn" onclick="restartGame()" style="margin-top: 30px;">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  </div>

  <div id="perfectEffect">PERFECT!</div>

  <audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

  <script>
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvasOutput');
    const ctx = canvas.getContext('2d');
    const currentMoveVisual = document.getElementById('currentMoveVisual');
    const finalScreen = document.getElementById('finalScreen');
    const finalScoresElem = document.getElementById('finalScores');
    const successSound = document.getElementById('successSound');
    const loadingText = document.getElementById('loadingText');
    const timerElem = document.getElementById('timer');
    const performanceInfo = document.getElementById('performanceInfo');
    const perfectEffect = document.getElementById('perfectEffect');

    const colors = ['#00ffff', '#ff00ff', '#ffaa00', '#00ff00', '#0088ff'];
    const playerValidated = [false, false, false, false, false];

    let trackedPlayers = [];
    let playerScores = [0, 0, 0, 0, 0];
    let isPaused = false;
    let startTime = null;
    let currentCommand = null;
    let commandInterval = null;
    let gameStarted = false;
    let lastFrameTime = 0;
    let frameCount = 0;
    let fps = 0;
    let poseDetector;

    const gameDuration = 60 * 1000;
    const commandDuration = 4000;
    const maxTrackingDistance = 100;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–±–∏–ª—å–Ω—ã–º, –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–∞–Ω–≤–∞—Å–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const canvasWidth = isMobile ? window.innerWidth : 1280; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
    const canvasHeight = isMobile ? window.innerHeight : 720; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã—Å–æ—Ç—É —ç–∫—Ä–∞–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö

    const commands = [
      {
        text: "üôã‚Äç‚ôÇÔ∏è –ü–æ–¥–Ω–∏–º–∏ –ø—Ä–∞–≤—É—é —Ä—É–∫—É",
        visualHint: "–ü—Ä–∞–≤–∞ —Ä—É–∫–∞ –≤–≥–æ—Ä—É",
        imageSrc: "https://via.placeholder.com/150/0000FF/FFFFFF?text=RightArmUp" /* –ó–∞–º–µ–Ω–∏ –Ω–∞ URL —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */,
        validate: (pose) => {
          const rw = pose.keypoints.find(p => p.name === 'right_wrist');
          const rs = pose.keypoints.find(p => p.name === 'right_shoulder');
          return rw && rs && rw.score > 0.25 && rs.score > 0.25 && rw.y < rs.y - 40;
        }
      },
      {
        text: "üôã‚Äç‚ôÄÔ∏è –ü–æ–¥–Ω–∏–º–∏ –ª–µ–≤—É—é —Ä—É–∫—É",
        visualHint: "–õ—ñ–≤–∞ —Ä—É–∫–∞ –≤–≥–æ—Ä—É",
        imageSrc: "https://via.placeholder.com/150/FF0000/FFFFFF?text=LeftArmUp" /* –ó–∞–º–µ–Ω–∏ –Ω–∞ URL —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */,
        validate: (pose) => {
          const lw = pose.keypoints.find(p => p.name === 'left_wrist');
          const ls = pose.keypoints.find(p => p.name === 'left_shoulder');
          return lw && ls && lw.score > 0.25 && ls.score > 0.25 && lw.y < ls.y - 40;
        }
      },
      {
        text: "üôå –ü–æ–¥–Ω–∏–º–∏ –æ–±–µ —Ä—É–∫–∏",
        visualHint: "–û–±–∏–¥–≤—ñ —Ä—É–∫–∏ –≤–≥–æ—Ä—É",
        imageSrc: "https://via.placeholder.com/150/00FF00/FFFFFF?text=BothArmsUp" /* –ó–∞–º–µ–Ω–∏ –Ω–∞ URL —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */,
        validate: (pose) => {
          const lw = pose.keypoints.find(p => p.name === 'left_wrist');
          const rw = pose.keypoints.find(p => p.name === 'right_wrist');
          const ls = pose.keypoints.find(p => p.name === 'left_shoulder');
          const rs = pose.keypoints.find(p => p.name === 'right_shoulder');
          return lw && rw && ls && rs &&
                 lw.score > 0.25 && rw.score > 0.25 && ls.score > 0.25 && rs.score > 0.25 &&
                 lw.y < ls.y - 40 && rw.y < rs.y - 40;
        }
      },
      {
        text: "üëá –û–ø—É—Å—Ç–∏ —Ä—É–∫–∏ –≤–Ω–∏–∑",
        visualHint: "–†—É–∫–∏ –≤–Ω–∏–∑",
        imageSrc: "https://via.placeholder.com/150/FFFF00/000000?text=ArmsDown" /* –ó–∞–º–µ–Ω–∏ –Ω–∞ URL —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */,
        validate: (pose) => {
          const lw = pose.keypoints.find(p => p.name === 'left_wrist');
          const rw = pose.keypoints.find(p => p.name === 'right_wrist');
          const lh = pose.keypoints.find(p => p.name === 'left_hip');
          const rh = pose.keypoints.find(p => p.name === 'right_hip');
          return lw && rw && lh && rh &&
                 lw.score > 0.25 && rw.score > 0.25 && lh.score > 0.25 && rh.score > 0.25 &&
                 lw.y > lh.y - 30 && rw.y > rh.y - 30;
        }
      },
      {
        text: "ü¶µ –ü–æ–¥–Ω–∏–º–∏ –ø—Ä–∞–≤—É—é –Ω–æ–≥—É",
        visualHint: "–ü—Ä–∞–≤–∞ –Ω–æ–≥–∞ –≤–≥–æ—Ä—É",
        imageSrc: "https://via.placeholder.com/150/FF00FF/FFFFFF?text=RightLegUp" /* –ó–∞–º–µ–Ω–∏ –Ω–∞ URL —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */,
        validate: (pose) => {
          const rAnkle = pose.keypoints.find(p => p.name === 'right_ankle');
          const lAnkle = pose.keypoints.find(p => p.name === 'left_ankle');
          return rAnkle && lAnkle &&
                 rAnkle.score > 0.25 && lAnkle.score > 0.25 &&
                 rAnkle.y < lAnkle.y - 60;
        }
      },
      {
        text: "ü¶µ –ü–æ–¥–Ω–∏–º–∏ –ª–µ–≤—É—é –Ω–æ–≥—É",
        visualHint: "–õ—ñ–≤–∞ –Ω–æ–≥–∞ –≤–≥–æ—Ä—É",
        imageSrc: "https://via.placeholder.com/150/00FFFF/000000?text=LeftLegUp" /* –ó–∞–º–µ–Ω–∏ –Ω–∞ URL —Å–≤–æ–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */,
        validate: (pose) => {
          const lAnkle = pose.keypoints.find(p => p.name === 'left_ankle');
          const rAnkle = pose.keypoints.find(p => p.name === 'right_ankle');
          return lAnkle && rAnkle &&
                 lAnkle.score > 0.25 && rAnkle.score > 0.25 &&
                 lAnkle.y < rAnkle.y - 60;
        }
      }
    ];

    function calculateDistance(point1, point2) {
      return Math.sqrt(Math.pow(point1.x - point2.x, 2) + Math.pow(point1.y - point2.y, 2));
    }

    function getPoseCenter(pose) {
      const validKeypoints = pose.keypoints.filter(kp => kp.score > 0.2);
      if (validKeypoints.length === 0) return null;

      const centerX = validKeypoints.reduce((sum, kp) => sum + kp.x, 0) / validKeypoints.length;
      const centerY = validKeypoints.reduce((sum, kp) => sum + kp.y, 0) / validKeypoints.length;

      return { x: centerX, y: centerY };
    }

    function trackPlayers(poses) {
      const currentFrame = poses.map(pose => ({
        pose,
        center: getPoseCenter(pose),
        assigned: false
      }));

      const newTrackedPlayers = [];

      trackedPlayers.forEach(trackedPlayer => {
        let bestMatch = null;
        let minDistance = Infinity;

        currentFrame.forEach(frameData => {
          if (frameData.assigned || !frameData.center) return;

          const distance = calculateDistance(trackedPlayer.lastCenter, frameData.center);
          if (distance < minDistance && distance < maxTrackingDistance) {
            minDistance = distance;
            bestMatch = frameData;
          }
        });

        if (bestMatch) {
          bestMatch.assigned = true;
          newTrackedPlayers[trackedPlayer.id] = {
            id: trackedPlayer.id,
            pose: bestMatch.pose,
            lastCenter: bestMatch.center,
            frames: trackedPlayer.frames + 1
          };
        }
      });

      currentFrame.forEach(frameData => {
        if (!frameData.assigned && frameData.center) {
          let newId = 0;
          while (newTrackedPlayers[newId]) {
            newId++;
          }
          if (newId < 5) {
            newTrackedPlayers[newId] = {
              id: newId,
              pose: frameData.pose,
              lastCenter: frameData.center,
              frames: 1
            };
          }
        }
      });

      trackedPlayers = newTrackedPlayers.filter(player => player !== undefined);

      return newTrackedPlayers.filter(Boolean);
    }

    function togglePause() {
      isPaused = !isPaused;
      const pauseButton = document.querySelector('.btn');
      if (isPaused) {
          pauseButton.textContent = '‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å';
          clearInterval(commandInterval);
      } else {
          pauseButton.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
          commandInterval = setInterval(updateCommand, commandDuration);
      }
    }

    function updateCommand() {
      if (isPaused || !gameStarted) return;

      playerValidated.fill(false);

      currentCommand = commands[Math.floor(Math.random() * commands.length)];

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–º fallback
      currentMoveVisual.innerHTML = `
          <img src="${currentCommand.imageSrc}" alt="${currentCommand.visualHint}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <span style="display:none;">${currentCommand.visualHint}</span>
      `;
      currentMoveVisual.style.animation = 'none';
      void currentMoveVisual.offsetWidth;
      currentMoveVisual.style.animation = `slideInMove 0.8s ease-out forwards, fadeOutMove 0.5s ${commandDuration / 1000 - 0.5}s forwards ease-in`;
    }

    function showPerfectEffect() {
        perfectEffect.style.animation = 'none';
        void perfectEffect.offsetWidth;
        perfectEffect.style.animation = 'perfectPulse 1s ease-out forwards';
    }

    function updateMultiScoreUI() {
      const container = document.getElementById('multiScoreBar');
      container.innerHTML = '';
      playerScores.forEach((score, index) => {
        const div = document.createElement('div');
        div.className = 'player-score';
        div.style.backgroundColor = colors[index % colors.length];
        div.textContent = `–ò–≥—Ä–æ–∫ ${index + 1}: ${score}`;
        container.appendChild(div);
      });
    }

    function updateTimer() {
      if (!gameStarted || isPaused) return;

      const elapsed = Date.now() - startTime;
      const remaining = Math.max(0, Math.ceil((gameDuration - elapsed) / 1000));
      timerElem.textContent = remaining;

      if (remaining <= 10 && remaining > 0) {
        timerElem.style.background = 'rgba(255,0,0,0.9)';
        timerElem.style.animation = 'pulse 0.5s infinite';
      } else if (remaining === 0) {
        timerElem.style.animation = 'none';
      } else {
        timerElem.style.background = 'rgba(255,69,0,0.9)';
        timerElem.style.animation = 'none';
      }
    }

    function calculateFPS() {
      frameCount++;
      const now = performance.now();
      if (now - lastFrameTime >= 1000) {
        fps = Math.round(frameCount * 1000 / (now - lastFrameTime));
        frameCount = 0;
        lastFrameTime = now;
        performanceInfo.textContent = `FPS: ${fps} | –ò–≥—Ä–æ–∫–æ–≤: ${trackedPlayers.length}`;
      }
    }

    function drawPose(pose, color, playerIndex) {
      const kp = pose.keypoints;
      const get = name => kp.find(p => p.name === name);

      ctx.fillStyle = color;
      kp.forEach(point => {
        if (point.score > 0.2) {
          ctx.beginPath();
          ctx.arc(point.x, point.y, 5, 0, 2 * Math.PI);
          ctx.fill();
        }
      });

      const pairs = [
        ["left_shoulder", "right_shoulder"],
        ["left_shoulder", "left_elbow"],
        ["left_elbow", "left_wrist"],
        ["right_shoulder", "right_elbow"],
        ["right_elbow", "right_wrist"],
        ["left_shoulder", "left_hip"],
        ["right_shoulder", "right_hip"],
        ["left_hip", "right_hip"],
        ["left_hip", "left_knee"],
        ["left_knee", "left_ankle"],
        ["right_hip", "right_knee"],
        ["right_knee", "right_ankle"]
      ];

      ctx.strokeStyle = color;
      ctx.lineWidth = 3;
      pairs.forEach(([a, b]) => {
        const p1 = get(a);
        const p2 = get(b);
        if (p1 && p2 && p1.score > 0.2 && p2.score > 0.2) {
          ctx.beginPath();
          ctx.moveTo(p1.x, p1.y);
          ctx.lineTo(p2.x, p2.y);
          ctx.stroke();
        }
      });

      const nose = get('nose');
      if (nose && nose.score > 0.2) {
        ctx.fillStyle = color;
        ctx.font = 'bold 20px Montserrat';
        ctx.textAlign = 'center';
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 5;
        ctx.strokeText(`${playerIndex + 1}`, nose.x, nose.y - 25);
        ctx.fillText(`${playerIndex + 1}`, nose.x, nose.y - 25);
      }
    }

    async function renderLoop() {
      if (!isPaused && video.readyState === 4 && poseDetector) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // –†–∏—Å—É–µ–º –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –Ω–∞ –∫–∞–Ω–≤–∞—Å–µ
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        try {
          const poses = await poseDetector.estimatePoses(video);
          const currentPlayers = trackPlayers(poses);

          currentPlayers.forEach(player => {
            drawPose(player.pose, colors[player.id], player.id);

            if (currentCommand && gameStarted && !playerValidated[player.id] && currentCommand.validate(player.pose)) {
              playerScores[player.id] += 100;
              playerValidated[player.id] = true;
              showPerfectEffect();

              if (navigator.vibrate) {
                navigator.vibrate(200);
              }

              try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–µ–∂–¥–µ —á–µ–º –∏–≥—Ä–∞—Ç—å –∑–≤—É–∫
                if (successSound.paused) {
                    successSound.play();
                } else {
                    successSound.currentTime = 0;
                    successSound.play();
                }
              } catch (e) {
                console.log('–ó–≤—É–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', e);
              }
            }
          });

          updateMultiScoreUI();
          updateTimer();

          if (gameStarted && Date.now() - startTime > gameDuration) {
            finishGame();
            return;
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∑:', error);
          // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –Ω–∞ —ç–∫—Ä–∞–Ω
        }
      }

      calculateFPS();
      requestAnimationFrame(renderLoop);
    }

    function finishGame() {
      clearInterval(commandInterval);
      gameStarted = false;
      finalScreen.style.display = 'flex';
      document.querySelector('.multi-score-bar').style.display = 'none';
      timerElem.style.display = 'none';
      document.querySelector('.bottom-commands-area').style.display = 'none';
      document.querySelector('.controls').style.display = 'none';
      performanceInfo.style.display = 'none';

      const maxScore = Math.max(...playerScores);
      const winners = playerScores.map((score, index) => ({ score, index }))
        .filter(p => p.score === maxScore);

      let resultsHTML = '<div style="margin-bottom: 20px;">';
      playerScores.forEach((score, i) => {
        const isWinner = score === maxScore;
        resultsHTML += `<div style="color: ${colors[i]}; margin: 5px 0; font-size: 20px; font-weight: bold;">
          –ò–≥—Ä–æ–∫ ${i + 1}: ${score} –æ—á–∫–æ–≤ ${isWinner ? 'üèÜ' : ''}
        </div>`;
      });
      resultsHTML += '</div>';

      if (winners.length === 1) {
        resultsHTML += `<div style="font-size: 24px; color: ${colors[winners[0].index]}; font-weight: bold; text-shadow: 1px 1px 5px rgba(0,0,0,0.5);">
          üéâ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: –ò–≥—Ä–æ–∫ ${winners[0].index + 1}! üéâ
        </div>`;
      } else {
        resultsHTML += `<div style="font-size: 20px; font-weight: bold;">ü§ù –ù–∏—á—å—è!</div>`;
      }

      finalScoresElem.innerHTML = resultsHTML;
    }

    function restartGame() {
      location.reload();
    }

    async function init() {
      try {
        loadingText.innerHTML = '<div>–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...</div>';

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        const constraints = {
          video: {
            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            width: { ideal: isMobile ? 640 : 1280 },
            height: { ideal: isMobile ? 480 : 720 },
            // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
            facingMode: 'user',
            frameRate: { ideal: isMobile ? 20 : 30 } // –°–Ω–∏–∂–∞–µ–º FPS –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
          },
          audio: false
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        // –ñ–¥–µ–º, –ø–æ–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã
        await new Promise(resolve => video.onloadedmetadata = resolve);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞–Ω–≤–∞—Å–∞ –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞–∑–º–µ—Ä–∞–º –≤–∏–¥–µ–æ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        canvas.width = video.videoWidth > 0 ? video.videoWidth : canvasWidth;
        canvas.height = video.videoHeight > 0 ? video.videoHeight : canvasHeight;

        loadingText.innerHTML = '<div>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –ò–ò...</div><div style="font-size: 14px; margin-top: 10px;">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</div>';

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏ Pose Detection
        // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LIGHTNING —Å –º–µ–Ω—å—à–∏–º multiPoseMaxDimension
        const modelType = isMobile ? poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING : poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING;
        const maxPoses = isMobile ? 1 : 6; // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –ª—É—á—à–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å 1 –ø–æ–∑—É –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

        poseDetector = await poseDetection.createDetector(
          poseDetection.SupportedModels.MoveNet,
          {
            modelType: modelType,
            maxPoses: maxPoses,
            minPoseScore: 0.2,
            multiPoseMaxDimension: isMobile ? 224 : 256,
            enableSmoothing: true,
            enableSegmentation: false
          }
        );

        loadingText.style.display = 'none';

        gameStarted = true;
        startTime = Date.now();
        lastFrameTime = performance.now();

        updateCommand();
        commandInterval = setInterval(updateCommand, commandDuration);

        renderLoop();

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
        if (error.name === 'NotAllowedError') {
          errorMessage = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞.';
        } else if (error.name === 'NotFoundError') {
          errorMessage = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞.';
        } else if (error.name === 'NotReadableError') {
            errorMessage = '–ö–∞–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
        } else if (error.name === 'OverconstrainedError') {
            errorMessage = '–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–º–µ—Ä—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è.';
        }
        loadingText.innerHTML = `<div>–û—à–∏–±–∫–∞: ${errorMessage}</div><div style="font-size: 14px; margin-top: 10px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</div>`;
      }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    document.addEventListener('touchmove', function(e) {
      e.preventDefault();
    }, { passive: false });

    init();
  </script>
</body>
</html>
